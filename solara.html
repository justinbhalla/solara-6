<!-- Solara v11 â€” dual canvases + op-log compatible -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Solara â€“ Adaptive Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    .drag-over{ background:rgba(99,102,241,.08); outline:2px dashed #6366f1; outline-offset:-2px }
    .menu-card{ box-shadow:0 10px 20px rgba(0,0,0,.08) }
    .editable{ outline:none; min-height:1.5rem }
    .dragging{ opacity:.6; transform:rotate(.4deg) }
    .drop-indicator{ height:.5rem; border-radius:.25rem; background:rgba(99,102,241,.45); margin:.25rem 0; display:none }
    .show-drop .drop-indicator{ display:block }
    .date-badge{ font-variant-numeric: tabular-nums }
    .presence-dot{ position:absolute; right:-2px; bottom:-2px; width:10px; height:10px; border-radius:999px; background:#10b981; border:2px solid white }
    .avatar{ position:relative }
    footer .slot{ min-width: 0 }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">

<!-- Workspace notice -->
<div id="wsBanner" class="hidden bg-amber-50 text-amber-900 border-b border-amber-200 px-6 py-2 text-sm">
  No workspace selected. <a class="underline font-medium" href="workspace.html">Go to Workspaces</a>
</div>

<!-- Header -->
<header class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
  <div class="flex items-center gap-3">
    <a id="workspacesLink" href="workspace.html" class="w-9 h-9 rounded-xl bg-indigo-600/10 text-indigo-600 flex items-center justify-center hover:bg-indigo-600/20" title="Back to Workspaces">ðŸ”·</a>
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Solara</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">Part of the ZLG Product Suite</p>
    </div>
  </div>

  <div class="flex items-center gap-4">
    <!-- Presence -->
    <div class="relative">
      <button id="presenceBtn" class="flex -space-x-2 items-center">
        <span id="presenceAvatars" class="flex -space-x-2"></span>
        <span id="presenceCount" class="ml-2 text-xs text-gray-500"></span>
      </button>
      <div id="presenceTooltip" class="hidden absolute right-0 mt-2 w-64 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 p-3 text-sm shadow">
        <div class="font-semibold mb-2">Online now</div>
        <div id="presenceList" class="space-y-1 max-h-56 overflow-auto"></div>
      </div>
    </div>

    <!-- User -->
    <div id="userArea" class="relative">
      <button id="userButton" class="flex items-center gap-2 px-3 py-2 rounded-full border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
        <span id="avatar" class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-indigo-600 text-white text-xs font-semibold">?</span>
        <span id="userName" class="text-sm font-medium">User</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
      </button>
      <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="px-4 py-3 text-sm">
          <div id="userEmail" class="text-gray-600 dark:text-gray-300"></div>
        </div>
        <div class="border-t border-gray-100 dark:border-gray-700"></div>
        <button id="addUserBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">Add userâ€¦</button>
        <button id="signOutBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">Sign out</button>
      </div>
    </div>
  </div>
</header>

<!-- Nav -->
<nav class="flex items-center justify-between px-6 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm font-medium">
  <div class="flex items-center gap-6">
    <button class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-semibold">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h14v2H3V3zm0 4h9v2H3V7zm0 4h14v2H3v-2zm0 4h9v2H3v-2z"/></svg>
      <span>Tasks</span>
    </button>
    <button id="reportsLink" class="flex items-center gap-2 text-gray-700 dark:text-gray-200 hover:text-indigo-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M7 16v-4m4 4V8m4 8V5"/></svg>
      <span>Reports</span>
    </button>
  </div>
  <div class="flex items-center gap-3">
    <!-- Left canvas actions -->
    <div class="flex items-center gap-2">
      <button id="clearBtnA" title="Clear all tasks (left tab)" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m0 0A2.99 2.99 0 017 6h10a2.99 2.99 0 012.418 3H19v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9h.582zM10 11v6m4-6v6"/></svg>
      </button>
      <button id="newTaskBtnA" class="px-3 py-1.5 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-500 shadow transition">+ Left</button>
    </div>
    <!-- Right canvas actions -->
    <div class="flex items-center gap-2">
      <button id="clearBtnB" title="Clear all tasks (right tab)" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m0 0A2.99 2.99 0 017 6h10a2.99 2.99 0 012.418 3H19v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9h.582zM10 11v6m4-6v6"/></svg>
      </button>
      <button id="newTaskBtnB" class="px-3 py-1.5 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-500 shadow transition">+ Right</button>
    </div>

    <button id="exportBtn" class="ml-1 p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition" title="Download Both Canvases">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm-7 4h14v-2H5v2z"/></svg>
    </button>
  </div>
</nav>

<!-- Dual canvases -->
<main class="p-6 flex-1 overflow-y-auto">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Canvas A -->
    <section class="flex flex-col bg-white/40 dark:bg-gray-800/40 rounded-lg border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">Left canvas</span>
          <select id="tabSelectA" class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-800"></select>
        </div>
        <div class="flex items-center gap-2">
          <button id="renameTabBtnA" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">Rename</button>
          <button id="deleteTabBtnA" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">Delete</button>
          <button id="addTabBtn" class="text-xs px-2 py-1 rounded bg-green-100 hover:bg-green-200 text-green-700 border border-green-200">+ Tab</button>
        </div>
      </div>
      <div id="boardA" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div id="todoA" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="todo"><h2 class="text-lg font-semibold mb-2">To Do</h2><div class="drop-indicator"></div></div>
        <div id="inprogressA" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="inprogress"><h2 class="text-lg font-semibold mb-2">In Progress</h2><div class="drop-indicator"></div></div>
        <div id="doneA" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="done"><h2 class="text-lg font-semibold mb-2">Done</h2><div class="drop-indicator"></div></div>
      </div>
    </section>

    <!-- Canvas B -->
    <section class="flex flex-col bg-white/40 dark:bg-gray-800/40 rounded-lg border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">Right canvas</span>
          <select id="tabSelectB" class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-800"></select>
        </div>
        <div class="flex items-center gap-2">
          <button id="renameTabBtnB" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">Rename</button>
          <button id="deleteTabBtnB" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">Delete</button>
        </div>
      </div>
      <div id="boardB" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div id="todoB" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="todo"><h2 class="text-lg font-semibold mb-2">To Do</h2><div class="drop-indicator"></div></div>
        <div id="inprogressB" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="inprogress"><h2 class="text-lg font-semibold mb-2">In Progress</h2><div class="drop-indicator"></div></div>
        <div id="doneB" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="done"><h2 class="text-lg font-semibold mb-2">Done</h2><div class="drop-indicator"></div></div>
      </div>
    </section>
  </div>
</main>

<!-- Footer -->
<div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 z-50">
  <footer class="grid grid-cols-3 items-center text-center text-xs text-gray-500 dark:text-gray-400 px-6 py-3">
    <div class="slot text-left truncate">Workspace: <span id="wsName">â€”</span></div>
    <div class="slot">Â© 2025 ZenLock Group (ZLG). All rights reserved.</div>
    <div class="slot text-right truncate"><span id="lastSynced">Last synced: â€”</span></div>
  </footer>
</div>

<!-- Members Modal (unchanged behavior) -->
<div id="membersModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
  <div class="absolute inset-0 bg-black/40" onclick="closeMembers()"></div>
  <div class="relative w-full max-w-lg rounded-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 p-5 shadow-xl">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Workspace Members</h3>
      <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" onclick="closeMembers()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="flex gap-2 mb-3">
      <input id="inviteEmail" type="email" placeholder="name@example.com" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm"/>
      <button id="inviteBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Invite</button>
    </div>
    <div id="membersList" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
  </div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const API_BASE = "https://shy-smoke-ab8e.justinbhalla28.workers.dev";
const apiUrl = p => API_BASE.replace(/\/+$/,'') + '/' + String(p||'').replace(/^\/+/,'');

/* ---------------- STATE ---------------- */
let WORKSPACE_ID = '';
let WORKSPACE_NAME = '';
let sessionJWT = null;
let authedUser = null;
let currentUserKey = null;
let currentRole = 'viewer';

const COLS = ['todo','inprogress','done'];
let tabData = {};                // { tabName: {todo:[], inprogress:[], done:[]} }
let ws = null;
let wsConnected = false;
let lastSeq = 0;                 // from /state.base_seq and incremented via ops
let syncing = false;

let presence = new Map(); // others only
let lastSyncedAt = null;

let presenceBeatTimer = null;
let presencePollTimer = null;
let syncPollTimer = null;

let isEditing = false;
let isDragging = false;
let editingTasks = new Set();
let hasRemoteDuringEdit = false;

// dual canvases
let activeTabA = null;
let activeTabB = null;

/* ---------------- UTIL ---------------- */
const debounce = (fn, ms=400)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
function getSessionJWT(){
  const m = document.cookie.match(/(?:^|; )(?:stytch_session_jwt|solara_session_jwt)=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : (localStorage.getItem('stytch_session_jwt') || localStorage.getItem('solara_session_jwt') || null);
}
function initials(name,email){ const parts=(name||'').trim().split(/\s+/).filter(Boolean); return parts.length?parts.slice(0,2).map(s=>s[0]).join('').toUpperCase():(email||'?').slice(0,2).toUpperCase(); }
function normalizeDateString(v){ if(!v) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; const d=new Date(v); if(isNaN(d)) return ''; const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
function stampSync(){ lastSyncedAt = new Date(); document.getElementById('lastSynced').textContent = 'Last synced: ' + lastSyncedAt.toLocaleTimeString(); }
function uuid(){ try { return crypto.randomUUID(); } catch { return Math.random().toString(36).slice(2); } }

/* A single place for fetch â€” always send credentials + Bearer */
async function apiFetch(path, opts={}){
  const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  if (sessionJWT) headers['Authorization'] = `Bearer ${sessionJWT}`;
  const res = await fetch(apiUrl(path), { credentials:'include', ...opts, headers });
  return res;
}

/* ---------------- AUTH ---------------- */
function displayNameFor(u){ const f=u?.name?.first_name, l=u?.name?.last_name, e=u?.email_addresses?.[0]?.email_address; return [f,l].filter(Boolean).join(' ') || e || 'User'; }
function updateAuthUI(){
  const name=displayNameFor(authedUser);
  const email=authedUser?.email_addresses?.[0]?.email_address||'';
  document.getElementById('avatar').textContent = initials(name,email);
  document.getElementById('userName').textContent = name;
  document.getElementById('userEmail').textContent = email;
}
async function verifySessionAndHydrate(){
  sessionJWT = getSessionJWT();
  if(!sessionJWT) return false;
  try{
    const r = await apiFetch('auth/check');
    if(!r.ok) return false;
    const data = await r.json();
    currentUserKey = data.user_id;
    const email = data.email ? [{ email_address: data.email }] : [];
    const parts = (data.name||'').split(/\s+/);
    authedUser = { name:{ first_name:parts[0]||'', last_name:parts.slice(1).join(' ')||'' }, email_addresses: email };
    localStorage.setItem('stytch_user', JSON.stringify(authedUser));
    updateAuthUI();
    return true;
  }catch{ return false; }
}

/* ---------------- MEMBERS / SHARES ---------------- */
async function fetchRole(){ const r=await apiFetch(`workspaces/${encodeURIComponent(WORKSPACE_ID)}/role`); if(!r.ok) return 'viewer'; const j=await r.json().catch(()=>({})); return j.role||'viewer'; }
async function listShares(){ const r=await apiFetch(`shares?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`); if(!r.ok) return []; const j=await r.json().catch(()=>({shares:[]})); return j.shares||[]; }
async function invite(email){ return apiFetch('shares', { method:'POST', body: JSON.stringify({ workspace_id: WORKSPACE_ID, email }) }); }
async function patchShareRole(id, role){ return apiFetch(`shares/${id}`, { method:'PATCH', body: JSON.stringify({ role }) }); }
async function removeShare(id){ return apiFetch(`shares/${id}`, { method:'DELETE' }); }
async function transferOwner(toEmail){ return apiFetch(`workspaces/${encodeURIComponent(WORKSPACE_ID)}/transfer_owner`, { method:'POST', body: JSON.stringify({ to_email: toEmail }) }); }

/* ---------------- V11 SNAPSHOT & OP-LOG ---------------- */
async function fetchState(){ const r=await apiFetch(`state?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`); if(!r.ok) throw new Error('state_failed'); const j=await r.json(); return j; }
async function syncSince(since){
  if(syncing) return; syncing=true;
  try{
    const r = await apiFetch(`sync?workspace_id=${encodeURIComponent(WORKSPACE_ID)}&since=${since}`);
    if(!r.ok){ syncing=false; return; }
    const data = await r.json();
    if(data.mode==='snapshot'){
      tabData = sanitizeTabs(data.tabs||{});
      lastSeq = Number(data.base_seq||0);
      renderAll();
      stampSync();
    } else if (data.mode==='ops'){
      const ops = data.ops||[];
      if(ops.length){
        applyOpsInOrder(ops);
        lastSeq = Number(ops[ops.length-1].seq||lastSeq);
        renderAll();
        stampSync();
      }
    }
  }catch{} finally{ syncing=false; }
}
function sanitizeTabs(tabs){
  const out = {}; COLS.forEach(()=>{});
  Object.keys(tabs||{}).forEach(tab=>{
    out[tab] = { todo:[], inprogress:[], done:[] };
    COLS.forEach(c=>{
      const list = Array.isArray(tabs[tab]?.[c])?tabs[tab][c]:[];
      const mapped = list.map(normalizeTaskJS);
      mapped.sort((a,b)=> (a.pos||0)-(b.pos||0)); mapped.forEach((t,i)=> t.pos=i+1);
      out[tab][c]=mapped;
    });
  });
  return out;
}
function normalizeTaskJS(t){
  return {
    id: String(t.id||'').trim() || `task-${uuid()}`,
    content: typeof t.content==='string'?t.content:'',
    dueDate: (/^\d{4}-\d{2}-\d{2}$/.test(t.dueDate||''))?t.dueDate:'',
    priority: ['High','Medium','Low'].includes(t.priority)?t.priority:'Medium',
    pos: Number.isFinite(+t.pos)?+t.pos:0,
    upd: Number.isFinite(+t.upd)?+t.upd:Date.now(),
    by: t.by||null
  };
}
function applyOpsInOrder(ops){
  for(const op of ops){ tabData = applyOpToTabs(tabData, op); }
}
function applyOpToTabs(currTabs, op){
  const tabs = JSON.parse(JSON.stringify(currTabs||{}));
  const p = op.payload||{}; const cols = COLS;
  function ensureTabShape(tab){ if(!tabs[tab]) tabs[tab]={todo:[],inprogress[],done:[]}; if(!tabs[tab].inprogress) tabs[tab].inprogress=[]; if(!tabs[tab].done) tabs[tab].done=[]; if(!tabs[tab].todo) tabs[tab].todo=[]; }
  function reindex(list){ list.forEach((t,i)=> t.pos=i+1); }

  if(op.type==='create_task'){
    const tab = (p.tab||'Default')+''; ensureTabShape(tab);
    const col = cols.includes(p.column)?p.column:'todo';
    const task = normalizeTaskJS(p.task||{});
    const list = tabs[tab][col];
    if(Number.isFinite(+task.pos)){ let idx=list.findIndex(x=>x.pos>task.pos); if(idx<0) idx=list.length; list.splice(idx,0,task); reindex(list); }
    else { task.pos=(list[list.length-1]?.pos||0)+1; list.push(task); }
    return tabs;
  }
  if(op.type==='update_task_field'){
    const id = String(p.task_id||''); const field = String(p.field||''); const val = p.value;
    for (const tb of Object.keys(tabs)){ for(const c of cols){ const t=tabs[tb][c].find(x=>x.id===id); if(t){ if(field==='content') t.content=String(val||''); else if(field==='dueDate') t.dueDate=(/^\d{4}-\d{2}-\d{2}$/.test(val||''))?val:''; else if(field==='priority' && ['High','Medium','Low'].includes(val)) t.priority=val; t.upd=Number(op.ts||Date.now()); t.by=op.client_id; return tabs; } } }
    return tabs;
  }
  if(op.type==='move_task'){
    const id=String(p.task_id||''); const to = cols.includes(p.to)?p.to:'todo';
    let foundTab=null, fromCol=null, idx=-1, task=null;
    for(const tb of Object.keys(tabs)){ for(const c of cols){ const i=tabs[tb][c].findIndex(x=>x.id===id); if(i!==-1){ foundTab=tb; fromCol=c; idx=i; task=tabs[tb][c][i]; break; } } if(task) break; }
    if(!task) return tabs;
    tabs[foundTab][fromCol].splice(idx,1); reindex(tabs[foundTab][fromCol]);
    const list = tabs[foundTab][to]; const pos=Number.isFinite(+p.pos)?+p.pos:null;
    if(pos==null){ task.pos=(list[list.length-1]?.pos||0)+1; list.push(task); }
    else { let insertAt=list.findIndex(x=>x.pos>pos); if(insertAt<0) insertAt=list.length; task.pos=pos; list.splice(insertAt,0,task); reindex(list); }
    task.upd=Number(op.ts||Date.now()); task.by=op.client_id; return tabs;
  }
  if(op.type==='delete_task'){
    const id=String(p.task_id||'');
    for(const tb of Object.keys(tabs)){ for(const c of cols){ const i=tabs[tb][c].findIndex(x=>x.id===id); if(i!==-1){ tabs[tb][c].splice(i,1); reindex(tabs[tb][c]); return tabs; } } }
    return tabs;
  }
  if(op.type==='rename_tab'){
    const from=String(p.from||''), to=String(p.to||'');
    if(!from||!to||from===to) return tabs;
    if(!tabs[from] || tabs[to]) return tabs;
    tabs[to]=tabs[from]; delete tabs[from]; return tabs;
  }
  return tabs;
}
function newPosBetween(prev, next){ const A=Number.isFinite(prev)?+prev:0; const B=Number.isFinite(next)?+next:A+2; if (B-A>1e-6) return A+(B-A)/2; return A+0.000001; }

/* Send op via WS if possible; else HTTP /ops */
async function sendOp(type, payload){
  const op = { type, op_id: uuid(), client_id: currentUserKey||'unknown', base_seq: lastSeq||0, ts: Date.now(), payload: payload||{} };
  // optimistic apply for snappy UX
  tabData = applyOpToTabs(tabData, { ...op, seq: lastSeq+1 });
  renderAll();

  if (wsConnected) { try{ ws.send(JSON.stringify({ type:'op:append', ws: WORKSPACE_ID, op })); return; }catch{} }
  try{
    const r = await apiFetch('ops',{ method:'POST', body: JSON.stringify({ workspace_id: WORKSPACE_ID, op }) });
    if(!r.ok) console.warn('op append failed');
  }catch(e){ console.warn('op append error', e); }
}

/* ---------------- PRESENCE HTTP ---------------- */
async function presenceBeatHTTP(){ try{ await apiFetch('presence/beat', { method:'POST', body: JSON.stringify({ workspace_id: WORKSPACE_ID }) }); }catch{} }
async function presencePollHTTP(){
  try{
    const r = await apiFetch(`presence?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`);
    if(!r.ok) return;
    const j = await r.json().catch(()=>({online:[]}));
    const mine = currentUserKey;
    presence.clear();
    (j.online||[]).forEach(p=>{ if(p.id!==mine) presence.set(p.id, { name:p.name, email:p.email }); });
    renderPresence();
  }catch{}
}

/* ---------------- LIVE WS ---------------- */
function liveUrl(){ try{ const u=new URL(API_BASE); u.pathname=(u.pathname.replace(/\/+$/,'')+'/live').replace(/\/{2,}/g,'/'); u.search=`?ws=${encodeURIComponent(WORKSPACE_ID)}&token=${encodeURIComponent(sessionJWT)}`; u.protocol=u.protocol.replace('http','ws'); return u.toString(); }catch{ return null; } }
function connectLive(){
  const url = liveUrl(); if(!url) { startHTTPFallback(); return; }
  try { ws = new WebSocket(url); } catch { startHTTPFallback(); return; }

  ws.onopen = ()=>{ wsConnected = true; stopSyncPolling(); };
  ws.onclose = ()=>{ wsConnected = false; startHTTPFallback(); };
  ws.onerror = ()=>{ wsConnected = false; startHTTPFallback(); };
  ws.onmessage = async (ev)=>{
    let msg = {}; try{ msg=JSON.parse(ev.data||'{}'); }catch{}
    if(msg.type==='hello' && msg.ws===WORKSPACE_ID){
      // v11 hello: { maxseq, online, you }
      currentUserKey = msg.you?.user_id || currentUserKey;
      presence.clear(); (msg.online||[]).forEach(p=> presence.set(p.id, { name:p.name, email:p.email })); renderPresence();
      if (Number(msg.maxseq||0) > lastSeq) { await syncSince(lastSeq); }
      return;
    }
    if(msg.type==='op' && msg.ws===WORKSPACE_ID){
      const seq = Number(msg.seq||0);
      if (seq !== lastSeq + 1) { await syncSince(lastSeq); return; }
      tabData = applyOpToTabs(tabData, msg.op||{});
      lastSeq = seq;
      if (!isEditing && !isDragging) { renderAll(); stampSync(); } else { hasRemoteDuringEdit = true; }
      return;
    }
    if(msg.type==='presence/join'){ if(msg.by && msg.by!==currentUserKey){ presence.set(msg.by, { name:msg.name||'', email:msg.email||'' }); renderPresence(); } return; }
    if(msg.type==='presence/leave'){ presence.delete(msg.by); renderPresence(); return; }
  };
}

/* ---------------- PRESENCE UI ---------------- */
function renderPresence(){
  const avatars=document.getElementById('presenceAvatars');
  const list=document.getElementById('presenceList');
  const count=document.getElementById('presenceCount');
  avatars.innerHTML=''; list.innerHTML='';

  const others = [...presence.entries()].map(([id,v])=>({id,...v})).sort((a,b)=>(a.name||a.email).localeCompare(b.name||b.email));
  count.textContent = others.length ? '' : '0 online';

  const max=4;
  others.slice(0,max).forEach(p=>{
    const span=document.createElement('span');
    span.className='avatar inline-flex items-center justify-center h-7 w-7 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[11px] font-semibold ring-2 ring-white';
    span.title=p.name||p.email; span.textContent=initials(p.name,p.email);
    const dot=document.createElement('span'); dot.className='presence-dot'; span.appendChild(dot);
    avatars.appendChild(span);

    const row=document.createElement('div');
    row.className='flex items-center gap-2';
    row.innerHTML=`<div class="relative inline-flex items-center justify-center h-6 w-6 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[10px] font-semibold">
      ${initials(p.name,p.email)}<span class="presence-dot" style="right:-1px;bottom:-1px;width:8px;height:8px"></span></div>
      <div class="truncate">${p.name||p.email}</div>`;
    list.appendChild(row);
  });
  if(others.length>max){
    const extra=others.length-max;
    const more=document.createElement('span');
    more.className='avatar inline-flex items-center justify-center h-7 w-7 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-[11px] font-semibold ring-2 ring-white';
    more.textContent = `+${extra}`; avatars.appendChild(more);
  }
}
document.getElementById('presenceBtn').onclick = ()=>{
  const t=document.getElementById('presenceTooltip');
  t.classList.toggle('hidden');
};

/* ---------------- RENDERING (dual canvases) ---------------- */
function renderTabSelectors(){
  const names = Object.keys(tabData);
  const selA = document.getElementById('tabSelectA');
  const selB = document.getElementById('tabSelectB');
  function fill(sel, active){
    const cur = sel.value;
    sel.innerHTML = '';
    names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.text=n; sel.appendChild(o); });
    sel.value = names.includes(active)?active:(names[0]||'');
  }
  fill(selA, activeTabA); fill(selB, activeTabB);
  activeTabA = selA.value; activeTabB = selB.value;
}
function renderAll(){
  renderTabSelectors();
  renderBoard('A'); renderBoard('B');
}
function ensureAtLeastOne(tab){ const cols=tabData[tab]; if(!cols) return; if((cols.todo?.length||0)+(cols.inprogress?.length||0)+(cols.done?.length||0)===0){ /* keep empty */ } }

function createTaskElement(id, content='', dueDate='', priority='Medium', column, pane){
  const w=document.createElement('div');
  w.id=id; w.setAttribute('data-task','1'); w.draggable=currentRole!=='viewer';
  w.className='relative p-3 rounded bg-white dark:bg-gray-700 shadow cursor-move mb-2'; w.setAttribute('data-column',column);

  const editable=document.createElement('div'); editable.className='editable w-full font-medium mb-1'; editable.contentEditable=(currentRole!=='viewer'); editable.innerText=content;
  const placeholder=document.createElement('span'); placeholder.className='absolute left-3 top-3 text-sm text-gray-400 pointer-events-none'; placeholder.textContent='Click to edit...';
  function toggle(){ placeholder.style.display = editable.innerText.trim()===''?'block':'none'; }

  const row=document.createElement('div'); row.className='flex items-center gap-2';
  const dateInput=document.createElement('input'); dateInput.type='date'; dateInput.value=normalizeDateString(dueDate)||''; dateInput.disabled=(currentRole==='viewer'); dateInput.className='mt-1 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-transparent rounded px-1 date-badge';
  const prioritySelect=document.createElement('select'); prioritySelect.disabled=(currentRole==='viewer'); prioritySelect.className='mt-1 ml-2 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded px-1';
  ['High','Medium','Low'].forEach(level=>{ const o=document.createElement('option'); o.value=level; o.text=level; if(level===priority) o.selected=true; prioritySelect.appendChild(o); });
  const del=document.createElement('button'); del.className='absolute top-2 right-2 text-gray-400 hover:text-red-500'; del.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'; del.title='Delete Task'; del.onclick=()=>{ if(currentRole==='viewer')return; if(confirm('Delete this task?')) sendOp('delete_task',{ task_id:id }); };

  // Smooth typing flags
  editable.addEventListener('focus', ()=>{ isEditing=true; editingTasks.add(id); });
  editable.addEventListener('blur', ()=>{ editingTasks.delete(id); if(editingTasks.size===0){ isEditing=false; if(hasRemoteDuringEdit){ hasRemoteDuringEdit=false; renderAll(); stampSync(); } } });
  editable.addEventListener('input', ()=>{ toggle(); sendOp('update_task_field',{ task_id:id, field:'content', value: editable.innerText.trim() }); });

  dateInput.addEventListener('focus', ()=>{ isEditing=true; editingTasks.add(id); });
  dateInput.addEventListener('blur', ()=>{ editingTasks.delete(id); if(editingTasks.size===0){ isEditing=false; if(hasRemoteDuringEdit){ hasRemoteDuringEdit=false; renderAll(); stampSync(); } } });
  dateInput.addEventListener('change', ()=> sendOp('update_task_field',{ task_id:id, field:'dueDate', value: normalizeDateString(dateInput.value) }));

  prioritySelect.addEventListener('focus', ()=>{ isEditing=true; editingTasks.add(id); });
  prioritySelect.addEventListener('blur', ()=>{ editingTasks.delete(id); if(editingTasks.size===0){ isEditing=false; if(hasRemoteDuringEdit){ hasRemoteDuringEdit=false; renderAll(); stampSync(); } } });
  prioritySelect.addEventListener('change', ()=> sendOp('update_task_field',{ task_id:id, field:'priority', value: prioritySelect.value||'Medium' }));

  w.addEventListener('dragstart',e=>{ if(currentRole==='viewer'){ e.preventDefault(); return; } isDragging=true; w.classList.add('dragging'); e.dataTransfer.setData('text/plain',id); dragContext.id=id; dragContext.fromCol=w.getAttribute('data-column'); dragContext.pane=pane; });
  w.addEventListener('dragend',()=>{ isDragging=false; w.classList.remove('dragging'); if(hasRemoteDuringEdit){ hasRemoteDuringEdit=false; renderAll(); stampSync(); } });

  row.appendChild(dateInput); row.appendChild(prioritySelect);
  w.appendChild(editable); w.appendChild(placeholder); w.appendChild(row); w.appendChild(del);
  toggle();
  return w;
}
const dragContext = { id:null, fromCol:null, overCol:null, insertIndex:null, pane:null };
function clearDrag(){ dragContext.id=null; dragContext.fromCol=null; dragContext.overCol=null; dragContext.insertIndex=null; dragContext.pane=null; }
function getAfter(container, y){
  const els=[...container.querySelectorAll('[data-task]:not(.dragging)')];
  return els.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const off=y-box.top-box.height/2; if(off<0 && off>closest.offset){ return {offset:off, element:child}; } else return closest; },{offset:-Infinity}).element;
}
function computeInsertIndex(colEl, indicator){
  const siblings=[...colEl.querySelectorAll('[data-task]')];
  if(siblings.length===0) return 0;
  const all=[...colEl.children]; let index=0;
  for(let i=0;i<all.length;i++){ const el=all[i]; if(el===indicator){ index=[...all.slice(0,i)].filter(n=>n.hasAttribute && n.hasAttribute('data-task')).length; return index; } }
  return siblings.length;
}
function renderBoard(pane){
  const active = pane==='A' ? activeTabA : activeTabB;
  if(!active || !tabData[active]) return;
  ensureAtLeastOne(active);

  const root = document.getElementById(pane==='A'?'boardA':'boardB');
  ['todo','inprogress','done'].forEach(col=>{
    const colEl = document.getElementById(col + pane);
    colEl.querySelectorAll('[data-task]')?.forEach(n=>n.remove());

    colEl.ondragover = (e)=>{
      e.preventDefault();
      colEl.classList.add('drag-over','show-drop');
      const after=getAfter(colEl, e.clientY);
      const indicator=colEl.querySelector('.drop-indicator');
      if(after==null){ colEl.appendChild(indicator); } else { colEl.insertBefore(indicator, after); }
      dragContext.overCol = colEl.dataset.col;
      dragContext.insertIndex = computeInsertIndex(colEl, indicator);
    };
    colEl.ondragleave = ()=>{ colEl.classList.remove('drag-over','show-drop'); };
    colEl.ondrop = (e)=>{
      e.preventDefault();
      colEl.classList.remove('drag-over','show-drop');
      const id=dragContext.id; if(!id) return;
      const list = tabData[active][dragContext.overCol]||[];
      const prev = list[dragContext.insertIndex-1]?.pos;
      const next = list[dragContext.insertIndex]?.pos;
      const pos = newPosBetween(prev, next);
      sendOp('move_task', { task_id:id, to: colEl.dataset.col, pos });
      clearDrag();
    };
  });

  ['todo','inprogress','done'].forEach(col=>{
    const colEl = document.getElementById(col + pane);
    (tabData[active][col]||[]).sort((a,b)=> (a.pos||0)-(b.pos||0)).forEach(t=> colEl.appendChild(createTaskElement(t.id,t.content,t.dueDate,t.priority,col,pane)));
  });
}

/* ---------------- Members UI ---------------- */
function openMembers(){ document.getElementById('membersModal').classList.remove('hidden'); renderMembers(); }
function closeMembers(){ document.getElementById('membersModal').classList.add('hidden'); }
async function renderMembers(){
  const list = document.getElementById('membersList');
  list.innerHTML = '<div class="py-6 text-sm text-gray-500">Loadingâ€¦</div>';
  const shares = await listShares();
  list.innerHTML = '';
  shares.forEach(s=>{
    const row=document.createElement('div');
    row.className='flex items-center justify-between py-3';
    const who=document.createElement('div'); who.className='flex items-center gap-3';
    const bubble=document.createElement('div'); bubble.className='h-8 w-8 rounded-full bg-indigo-600/15 text-indigo-700 dark:text-indigo-300 flex items-center justify-center text-xs font-semibold';
    bubble.textContent = initials('', s.email||'');
    const meta=document.createElement('div'); meta.innerHTML = `<div class="text-sm font-medium">${s.email||'â€”'}</div>`;
    who.appendChild(bubble); who.appendChild(meta);

    const actions=document.createElement('div'); actions.className='flex items-center gap-2';
    if (s.role === 'owner') {
      const tag=document.createElement('span'); tag.className='text-xs text-gray-500'; tag.textContent='owner';
      actions.appendChild(tag);
    } else if (currentRole==='owner' && s.id) {
      const sel=document.createElement('select');
      sel.className='text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-800';
      ['editor','viewer','owner'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.text=r; if(String(s.role||'editor')===r) o.selected=true; sel.appendChild(o); });
      sel.onchange = async ()=>{
        if(sel.value==='owner'){
          if(!confirm(`Transfer ownership to ${s.email}? You will lose owner privileges.`)) { sel.value = s.role||'editor'; return; }
          const r=await transferOwner(s.email||''); if(!r.ok){ alert('Failed to transfer'); sel.value=s.role||'editor'; } else { alert('Ownership transferred'); closeMembers(); location.reload(); }
          return;
        }
        const r=await patchShareRole(s.id, sel.value); if(!r.ok) alert('Failed to update role');
      };
      const del=document.createElement('button'); del.className='px-2 py-1 text-xs rounded bg-red-50 text-red-600 hover:bg-red-100'; del.textContent='Remove';
      del.onclick = async ()=>{ if(!confirm('Remove this member?')) return; const r=await removeShare(s.id); if(r.ok) renderMembers(); else alert('Failed to remove'); };
      actions.appendChild(sel); actions.appendChild(del);
    }
    row.appendChild(who); row.appendChild(actions); list.appendChild(row);
  });
}

/* ---------------- Boot / fallback orchestration ---------------- */
function setReportsHref(){
  const btn=document.getElementById('reportsLink');
  if(btn){ btn.onclick=()=>{ if(!WORKSPACE_ID){ alert('Open a workspace first.'); return; } location.href=`reports.html?ws=${encodeURIComponent(WORKSPACE_ID)}`; }; }
  const logo=document.getElementById('workspacesLink'); if(logo){ logo.href='workspace.html'; }
}
function stopSyncPolling(){ if(syncPollTimer){ clearInterval(syncPollTimer); syncPollTimer=null; } }
function startHTTPFallback(){
  if(!presenceBeatTimer){ presenceBeatHTTP(); presenceBeatTimer = setInterval(presenceBeatHTTP, 10000); }
  if(!presencePollTimer){ presencePollHTTP(); presencePollTimer = setInterval(presencePollHTTP, 5000); }
  if(!syncPollTimer){
    syncPollTimer = setInterval(async ()=>{ if(isEditing||isDragging) return; await syncSince(lastSeq); }, 1500);
  }
}

async function chooseWorkspaceId(){
  const url=new URL(location.href);
  let wid = url.searchParams.get('ws') || localStorage.getItem('solara_last_ws') || '';
  if (wid) return wid;

  // if none, pick first or create one
  const r = await apiFetch('workspaces'); const j = r.ok? await r.json(): { workspaces:[] };
  const first = (j.workspaces||[])[0];
  if (first) wid = first.id;
  else {
    const created = await apiFetch('workspaces', { method:'POST', body: JSON.stringify({ name: 'Personal' }) }).then(r=>r.json()).catch(()=>null);
    wid = created?.workspace?.id || '';
  }
  if (wid){
    localStorage.setItem('solara_last_ws', wid);
    const u = new URL(location.href); u.searchParams.set('ws', wid); history.replaceState(null,'',u.toString());
  }
  return wid;
}

async function boot(){
  const ok = await verifySessionAndHydrate();
  if(!ok){ location.replace('/sign-in.html'); return; }

  setReportsHref();

  WORKSPACE_ID = await chooseWorkspaceId();
  if(!WORKSPACE_ID){ document.getElementById('wsBanner').classList.remove('hidden'); return; }

  // Role + Name
  currentRole = await fetchRole();
  const wlist = await apiFetch('workspaces').then(r=>r.ok?r.json():{workspaces:[]}).catch(()=>({workspaces:[]}));
  const wsRow = (wlist.workspaces||[]).find(w=>w.id===WORKSPACE_ID);
  WORKSPACE_NAME = wsRow?.name || '';
  document.getElementById('wsName').textContent = WORKSPACE_NAME || 'â€”';
  if (wsRow && wsRow.owner_id && currentRole !== 'owner' && wsRow.owner_id === currentUserKey) currentRole = 'owner';

  // Snapshot bootstrap
  try{
    const state = await fetchState();
    tabData = sanitizeTabs(state.tabs||{});
    lastSeq = Number(state.base_seq||0);
  }catch{
    tabData = {};
    lastSeq = 0;
  }
  if(Object.keys(tabData).length===0){ tabData['Click to edit']={ todo:[], inprogress:[], done:[] }; }
  activeTabA = Object.keys(tabData)[0]; activeTabB = Object.keys(tabData)[0];
  renderAll();

  // HTTP fallback + Live
  startHTTPFallback();
  connectLive();

  stampSync();
}

/* ---------------- Events ---------------- */
document.getElementById('addTabBtn').onclick = ()=>{
  if(currentRole==='viewer') return;
  const name=prompt('Enter tab name:'); if(!name||!name.trim()) return; const n=name.trim();
  if(tabData[n]) return alert('Tab already exists.');
  // create by renaming empty temp
  tabData[n] = { todo:[], inprogress:[], done:[] };
  renderAll();
};

function renameFlow(which){
  const cur = which==='A'?activeTabA:activeTabB;
  const nn = prompt('Rename tab:', cur);
  if(!nn||!nn.trim()||nn===cur||tabData[nn]) return;
  sendOp('rename_tab', { from: cur, to: nn });
}
function deleteFlow(which){
  const cur = which==='A'?activeTabA:activeTabB;
  if(!confirm(`Delete tab "${cur}"?`)) return;
  // delete by moving through delete_task ops (simple approach)
  const lists = COLS.flatMap(c=> (tabData[cur]?.[c]||[]));
  lists.forEach(t=> sendOp('delete_task', { task_id: t.id }));
  // also rename to a unique temp then drop locally (for immediate UX)
  delete tabData[cur];
  const names = Object.keys(tabData); activeTabA = names[0]||null; activeTabB = names[0]||null;
  renderAll();
}

document.getElementById('renameTabBtnA').onclick = ()=> renameFlow('A');
document.getElementById('renameTabBtnB').onclick = ()=> renameFlow('B');
document.getElementById('deleteTabBtnA').onclick = ()=> deleteFlow('A');
document.getElementById('deleteTabBtnB').onclick = ()=> deleteFlow('B');

document.getElementById('tabSelectA').onchange = (e)=>{ activeTabA = e.target.value; renderBoard('A'); };
document.getElementById('tabSelectB').onchange = (e)=>{ activeTabB = e.target.value; renderBoard('B'); };

function addNewTask(which){
  if(currentRole==='viewer') return;
  const tab = which==='A'?activeTabA:activeTabB; if(!tab) return;
  const list = tabData[tab]?.todo||[]; const pos=(list[list.length-1]?.pos||0)+1;
  const id = `task-${uuid()}`;
  sendOp('create_task', { tab, column:'todo', task:{ id, content:'', dueDate:'', priority:'Medium', pos }});
  // focus will occur on next render (optional: delay + query)
  setTimeout(()=>{ document.getElementById(id)?.querySelector('.editable')?.focus(); }, 50);
}
document.getElementById('newTaskBtnA').onclick = ()=> addNewTask('A');
document.getElementById('newTaskBtnB').onclick = ()=> addNewTask('B');

async function clearAll(which){
  if(currentRole==='viewer') return;
  const tab = which==='A'?activeTabA:activeTabB; if(!tab) return;
  if(!confirm(`Clear all tasks in "${tab}"?`)) return;
  const lists = COLS.flatMap(c=> (tabData[tab]?.[c]||[]));
  for(const t of lists){ await sendOp('delete_task', { task_id: t.id }); }
}
document.getElementById('clearBtnA').onclick = ()=> clearAll('A');
document.getElementById('clearBtnB').onclick = ()=> clearAll('B');

document.getElementById('exportBtn').onclick = ()=>{
  const wrapper=document.createElement('div');
  wrapper.innerHTML='';
  const cloneA = document.getElementById('boardA').cloneNode(true);
  const cloneB = document.getElementById('boardB').cloneNode(true);
  wrapper.appendChild(cloneA); wrapper.appendChild(document.createElement('hr')); wrapper.appendChild(cloneB);
  html2pdf().set({ margin:.5, filename:'Solara-Boards.pdf', image:{type:'jpeg',quality:.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter', orientation:'landscape'} }).from(wrapper).save();
};

document.getElementById('userButton').onclick = ()=> document.getElementById('userMenu').classList.toggle('hidden');
document.getElementById('addUserBtn').onclick = ()=> openMembers();
document.getElementById('signOutBtn').onclick = async ()=>{
  try{ if(sessionJWT){ await apiFetch('logout', { method:'POST' }).catch(()=>{}); } } finally {
    localStorage.removeItem('stytch_session_jwt'); localStorage.removeItem('solara_session_jwt'); location.replace('/sign-in.html');
  }
};
document.getElementById('inviteBtn').onclick = async ()=>{
  const input=document.getElementById('inviteEmail'); const email=(input.value||'').trim().toLowerCase(); if(!email) return;
  const r=await invite(email); if(r.ok){ input.value=''; renderMembers(); alert('Invitation created.'); } else { alert('Invite failed.'); }
};

/* kick it */
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
